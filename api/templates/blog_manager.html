<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blogs Manager</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f9f9f9; }
    .container { max-width: 800px; margin: 0 auto; }
    .card { background:white; padding:20px; border-radius:8px; margin-bottom:20px; }
    .btn { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
    .btn-primary { background:#667eea; color:white; }
    .btn-danger { background:#f44336; color:white; }
    .btn-edit { background:#4CAF50; color:white; }
    input, textarea, select { width:100%; padding:8px; margin:5px 0 15px 0; border-radius:4px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 id="formTitle">‚úçÔ∏è Create Blog</h2>
      <form id="blogForm">
        <input type="hidden" id="blogId">
        <div>
          <label>Title</label>
          <input type="text" id="title" required>
        </div>
        <div>
          <label>Description</label>
          <textarea id="description" rows="5" required></textarea>
        </div>
        <div>
          <label>Category</label>
          <select id="categorySelect"></select>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Create</button>
        <button type="button" class="btn btn-danger" id="cancelBtn" style="display:none;">Cancel</button>
      </form>
    </div>

    <div class="card">
      <h2>üìù My Blogs</h2>
      <div id="myBlogsContainer">Loading...</div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/blogs';
    const CATEGORY_API = '/api/category/fetch-all/';
    const accessToken = localStorage.getItem('access');
    const currentUserId = parseInt(localStorage.getItem('userId'));
    let editingId = null;

    async function loadCategories() {
      try {
        const res = await fetch(CATEGORY_API, { headers: { 'Authorization': `Bearer ${accessToken}` } });
        const data = await res.json();
        const select = document.getElementById('categorySelect');
        select.innerHTML = '';
        data.data.forEach(cat => {
          select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
        });
      } catch (err) {
        console.error("Error loading categories:", err);
      }
    }

    async function loadMyBlogs() {
      try {
        const res = await fetch(`${API_BASE}/fetch-user-blogs/`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        console.log('Blogs fetched:', data.blogs);
        const container = document.getElementById('myBlogsContainer');
        container.innerHTML = '';
        data.blogs.forEach(blog => {
          container.innerHTML += `
            <div style="border:1px solid #ddd; padding:12px; margin-bottom:10px; border-radius:6px;">
              <h3>${blog.title}</h3>
              <p>${blog.description}</p>
              <small>Category: ${blog.category_name}</small><br>
              <button class="btn btn-edit" onclick="editBlog(${blog.id}, '${blog.title.replace(/'/g,"\\'")}', \`${blog.description.replace(/`/g,"\\`")}\`, ${blog.category})">Edit</button>
              <button class="btn btn-danger" onclick="deleteBlog(${blog.id})">Delete</button>
            </div>
          `;
        });
        if (!container.innerHTML) container.innerHTML = "No blogs found.";
      } catch (err) {
        console.error("Error loading blogs:", err);
        document.getElementById('myBlogsContainer').innerHTML = "Failed to load blogs.";
      }
    }
    async function createOrUpdateBlog(e) {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const category = document.getElementById('categorySelect').value;

      const url = editingId ? `${API_BASE}/${editingId}/update-blog/` : `${API_BASE}/create-blogs/`;
      const method = editingId ? 'PATCH' : 'POST';

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, category })
        });
        const data = await res.json();
        alert(data.message);
        cancelEdit();
        loadMyBlogs();
      } catch (err) {
        console.error("Error creating/updating blog:", err);
        alert("Failed to save blog.");
      }
    }

    function editBlog(id, title, description, categoryId) {
      editingId = id;
      document.getElementById('blogId').value = id;
      document.getElementById('title').value = title;
      document.getElementById('description').value = description;
      document.getElementById('categorySelect').value = categoryId;
      document.getElementById('formTitle').innerText = "‚úèÔ∏è Update Blog";
      document.getElementById('submitBtn').innerText = "Update";
      document.getElementById('cancelBtn').style.display = 'inline-block';
    }

    function cancelEdit() {
      editingId = null;
      document.getElementById('blogForm').reset();
      document.getElementById('formTitle').innerText = "‚úçÔ∏è Create Blog";
      document.getElementById('submitBtn').innerText = "Create";
      document.getElementById('cancelBtn').style.display = 'none';
    }

    async function deleteBlog(id) {
      if (!confirm("Delete this blog?")) return;
      try {
        const res = await fetch(`${API_BASE}/${id}/delete-blog/`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        alert(data.message);
        loadMyBlogs();
      } catch (err) {
        console.error("Error deleting blog:", err);
        alert("Failed to delete blog.");
      }
    }

    document.getElementById('blogForm').addEventListener('submit', createOrUpdateBlog);
    document.getElementById('cancelBtn').addEventListener('click', cancelEdit);

    loadCategories();
    loadMyBlogs();
  </script>
</body>
</html>
